bundle:
  name: databricks-chatbot

sync:
  include:
    - patches/**

variables:
  serving_endpoint_name:
    description: "Name of the model serving endpoint to be used by the app"
    default: "databricks-gpt-5-2"
  database_instance_name:
    description: "Base name of the Lakebase database instance"
    default: "chatbot-lakebase"
  resource_name_suffix:
    description: "Suffix for resource names (app/lakebase instance names etc). Helpful for avoiding name collisions if multiple users deploy this app to the same workspace"
  volume_catalog:
    description: "Unity Catalog name for file storage"
    default: "jmr_demo"
  volume_schema:
    description: "Schema for file storage volume"
    default: "default"
  volume_name:
    description: "Volume name for file storage"
    default: "chatbot-files"
  # OTEL Tracing Configuration (Optional)
  # Note: DATABRICKS_HOST is auto-provided by Databricks Apps runtime
  otel_uc_table_spans:
    description: "Unity Catalog table for trace spans"
    default: "jmr_demo.zerobus.otel_spans"
  otel_uc_table_metrics:
    description: "Unity Catalog table for metrics"
    default: "jmr_demo.zerobus.otel_metrics"
  otel_uc_table_logs:
    description: "Unity Catalog table for logs"
    default: "jmr_demo.zerobus.otel_logs"
  api_token:
    description: "token for OTEL zerobus ingest"
    default: ""


resources:
  database_instances:
    # Database resource enabled for persistent chat history
    chatbot_lakebase:
      # NOTE: customize the Lakebase instance name here, if desired
      name: ${var.database_instance_name}-${var.resource_name_suffix}
      capacity: CU_1

  # Volume resource for file storage (created by DAB)
  volumes:
    chatbot_files:
      catalog_name: ${var.volume_catalog}
      schema_name: ${var.volume_schema}
      name: ${var.volume_name}-${var.resource_name_suffix}
      volume_type: MANAGED
      comment: "File storage for chatbot application"

  apps:
    databricks_chatbot:
      # NOTE: customize the app name here, if desired
      name: db-chatbot-${var.resource_name_suffix}
      description: "Agentic Chat application for Foundation Models, Agent Bricks, and custom code agents"
      source_code_path: .
      config:
        command: ["npm", "run", "start"]
        env:
          - name: VOLUME_CATALOG
            value: ${var.volume_catalog}
          - name: VOLUME_SCHEMA
            value: ${var.volume_schema}
          - name: VOLUME_NAME
            value: ${var.volume_name}-${var.resource_name_suffix}
          - name: DATABRICKS_SERVING_ENDPOINT
            value: ${var.serving_endpoint_name}
          # OTEL Tracing Configuration
          # DATABRICKS_HOST is auto-provided by Databricks Apps runtime
          - name: OTEL_SERVICE_NAME
            value: db-chatbot-${var.resource_name_suffix}
          - name: DATABRICKS_UC_TABLE_SPANS
            value: ${var.otel_uc_table_spans}
          - name: DATABRICKS_UC_TABLE_METRICS
            value: ${var.otel_uc_table_metrics}
          - name: DATABRICKS_UC_TABLE_LOGS
            value: ${var.otel_uc_table_logs}
          - name: DATABRICKS_API_TOKEN
            value_from: anthropic_secret
          - name: OTEL_VERBOSE
            value: "true"

      resources:
        - name: serving-endpoint
          description: "Databricks serving endpoint name for the AI agent"
          serving_endpoint:
            name: ${var.serving_endpoint_name}
            permission: CAN_QUERY
        - name: database
          description: "Lakebase database instance for the chat app"
          database:
            database_name: databricks_postgres
            instance_name: ${resources.database_instances.chatbot_lakebase.name}
            permission: CAN_CONNECT_AND_CREATE
        - name: volume
          description: "Unity Catalog volume for file storage"
          uc_securable:
            securable_full_name: ${var.volume_catalog}.${var.volume_schema}.${var.volume_name}-${var.resource_name_suffix}
            securable_type: VOLUME
            permission: WRITE_VOLUME
        - name: anthropic_secret
          description: "Anthropic API authentication token"
          secret:
            scope: jmr_demo
            key: ANTHROPIC_AUTH_TOKEN
            permission: READ

targets:
  dev:
    # mode: development
    default: true
    workspace:
      host: https://fe-vm-vdm-classic-rikfy0.cloud.databricks.com
    variables:
      resource_name_suffix: dev-${workspace.current_user.domain_friendly_name}

  staging:
    mode: production
    variables:
      resource_name_suffix: "staging"

  prod:
    mode: production
    variables:
      resource_name_suffix: "prod"
